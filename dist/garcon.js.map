{"version":3,"file":"garcon.js","sources":["../src/garcon.ts"],"sourcesContent":["ï»¿import * as http from 'http';\r\nimport { Inject, Injector, Annotable } from 'stimpack';\r\nimport { default as pathToRegexp, PathToRegExpKey } from 'path-to-regexp';\r\n\r\nimport Context from './Context';\r\n\r\nexport interface RequestHandler {\r\n    handleRequest(ctx: Context): Promise<any>;\r\n}\r\n\r\nexport interface RequestHandlerConstructor extends Annotable {\r\n    prototype: RequestHandler;\r\n}\r\n\r\n@Inject\r\nexport default class Server {\r\n\r\n    static Context = Context;\r\n\r\n    private server: http.Server;\r\n\r\n    private routes: Map<RegExp, [RequestHandler, PathToRegExpKey[]]> = new Map<RegExp, [RequestHandler, PathToRegExpKey[]]>();\r\n\r\n    constructor(private injector: Injector) {\r\n        this.server = new http.Server();\r\n        this.server.on('request', (req: http.ServerRequest, res: http.ServerResponse) => {\r\n            this.handleRequest(req, res);\r\n        });\r\n    }\r\n\r\n    listen(port: number, hostname?: string, backlog?: number) {\r\n        this.server.listen(port, hostname, backlog);\r\n    }\r\n\r\n    get(route: string, handler: RequestHandlerConstructor) {\r\n        const keys = [];\r\n        const re = pathToRegexp(route, keys, { sensitive: true });\r\n        const hndl = this.injector.get(handler);\r\n        this.routes.set(re, [hndl, keys]);\r\n    }\r\n\r\n    private async handleRequest(req: http.ServerRequest, res: http.ServerResponse) {\r\n        const ctx = new Context(req, res);\r\n        try {\r\n            for (let [route, [handler, keys]] of this.routes) {\r\n                if (route.test(req.url)) {\r\n                    await handler.handleRequest(ctx);\r\n                }\r\n            }\r\n        } catch (e) {\r\n            res.statusCode = 500;\r\n            res.end(e.stack);\r\n        }\r\n        \r\n    }\r\n}"],"names":["Server","Server.handleRequest","Server.get","Server.listen","Server.constructor"],"mappings":";;;;;;;;;;;;;;;;oBAAsB,MAAM;;IAAhB,IAAI;;wBAC4B,UAAU;;4BACG,gBAAgB;;;;uBAErD,WAAW;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAU/B,IAAA,MAAA;iBASAA,gBAAwBA,QAAkBA,EAA1CA;;;;;AAAwBI,YAAxBA,CAAAA,QAAgCA,GAARA,QAAQA,CAAUA;AAF9BA,YAAZA,CAAAA,MAAkBA,GAAqDA,IAAIA,GAAGA,EAA+CA,CAACA;AAGtHA,YAAIA,CAACA,MAAMA,GAAGA,IAAIA,IAAIA,CAACA,MAAMA,EAAEA,CAACA;AAChCA,YAAIA,CAACA,MAAMA,CAACA,EAAEA,CAACA,SAASA,EAAEA,UAACA,GAAuBA,EAAEA,GAAwBA,EAApFA;AACYA,kBAAKA,aAAaA,CAACA,GAAGA,EAAEA,GAAGA,CAACA,CAACA;SAChCA,CAACA,CAACA;KACNA;;;;eAEKJ,gBAACA,IAAYA,EAAEA,QAAiBA,EAAEA,OAAgBA,EAA5DA;AACQG,gBAAIA,CAACA,MAAMA,CAACA,MAAMA,CAACA,IAAIA,EAAEA,QAAQA,EAAEA,OAAOA,CAACA,CAACA;SAC/CA;;;eAEEH,aAACA,KAAaA,EAAEA,OAAkCA,EAAzDA;AACQE,gBAAMA,IAAIA,GAAGA,EAAEA,CAACA;AAChBA,gBAAMA,EAAEA,GAAGA,+BAAaA,KAAKA,EAAEA,IAAIA,EAAEA,EAAEA,SAASA,EAAEA,IAAIA,EAAEA,CAACA,CAACA;AAC1DA,gBAAMA,IAAIA,GAAGA,IAAIA,CAACA,QAAQA,CAACA,GAAGA,CAACA,OAAOA,CAACA,CAACA;AACxCA,gBAAIA,CAACA,MAAMA,CAACA,GAAGA,CAACA,EAAEA,EAAEA,CAACA,IAAIA,EAAEA,IAAIA,CAACA,CAACA,CAACA;SACrCA;;;eAE0BF,uBAACA,GAAuBA,EAAEA,GAAwBA,EAAjFA;;oBACcC,GAAGA,+FAEKA,KAAKA,iBAAGA,OAAOA,EAAEA,IAAIA;;;;;AAF7BA,+BAAGA,GAAGA,yBAAYA,GAAGA,EAAEA,GAAGA,CAACA;;;;;;wCAEQA,IAAIA,CAACA,MAAMA;;;;;;;;;AAAtCA,iCAAKA;;AAAGA,mCAAOA;AAAEA,gCAAIA;;iCACvBA,KAAKA,CAACA,IAAIA,CAACA,GAAGA,CAACA,GAAGA,CAACA;;;;;;mCACbA,OAAOA,CAACA,aAAaA,CAACA,GAAGA,CAACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIxCA,+BAAGA,CAACA,UAAUA,GAAGA,GAAGA,CAACA;AACrBA,+BAAGA,CAACA,GAAGA,CAACA,eAAEA,KAAKA,CAACA,CAACA;;;;;;;aAGxBA,GAALA,IAAAA,CAAAA,CAAAA;SAAKD;;;;IACJA,CAADA;AAtCW,MAAX,CAAA,OAAkB,uBAAU,CAAC;AAH7B,MAAA,GAAA,UAAA,CAAA,WAbS,MAAM,6CAAE,QAAQ,GAsDzB,EAAA,MAAA,CAAA,CAAC;qBAAD,MAAA"}